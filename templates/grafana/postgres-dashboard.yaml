{{- if and .Values.monitoring.postgresDashboards (default false .Values.monitoring.postgresDashboards.enabled) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-postgres
  labels:
    grafana_dashboard: "1"
data:
  postgres.json: |
    {"id":null,"uid":null,"title":"PostgreSQL","tags":["postgresql"],"timezone":"browser","schemaVersion":37,"version":1,"refresh":"1m","panels":[{"type":"timeseries","title":"Active Connections","datasource":"Postgres","targets":[{"format":"time_series","rawSql":"SELECT now() as time, count(*) as connections FROM pg_stat_activity;","refId":"A"}],"fieldConfig":{"defaults":{"unit":"short"}},"gridPos":{"h":4,"w":8,"x":0,"y":0}},{"type":"table","title":"Top Slow Queries (Last Hour)","datasource":"Postgres","targets":[{"format":"table","rawSql":"SELECT query, round(EXTRACT(EPOCH FROM (now() - query_start))/60,2) AS duration_min FROM pg_stat_activity WHERE state != 'idle' AND query_start > now() - interval '1 hour' ORDER BY duration_min DESC LIMIT 10;","refId":"B"}],"gridPos":{"h":4,"w":8,"x":8,"y":0}},{"type":"table","title":"Database Sizes","datasource":"Postgres","targets":[{"format":"table","rawSql":"SELECT pg_database.datname AS database, pg_size_pretty(pg_database_size(pg_database.datname)) AS size FROM pg_database ORDER BY pg_database_size(pg_database.datname) DESC;","refId":"C"}],"gridPos":{"h":4,"w":8,"x":0,"y":4}},{"type":"table","title":"Table Sizes","datasource":"Postgres","targets":[{"format":"table","rawSql":"SELECT relname AS table, pg_size_pretty(pg_total_relation_size(relid)) AS total_size FROM pg_catalog.pg_statio_user_tables ORDER BY pg_total_relation_size(relid) DESC;","refId":"D"}],"gridPos":{"h":4,"w":8,"x":8,"y":4}},{"type":"stat","title":"Cache Hit Ratio (%)","datasource":"Postgres","targets":[{"format":"table","rawSql":"SELECT round((sum(blks_hit) / nullif(sum(blks_hit) + sum(blks_read),0)) * 100, 2) AS cache_hit_pct FROM pg_stat_database;","refId":"E"}],"fieldConfig":{"defaults":{"unit":"percent"}},"gridPos":{"h":2,"w":4,"x":0,"y":8}},{"type":"stat","title":"Deadlocks (Last Hour)","datasource":"Postgres","targets":[{"format":"table","rawSql":"SELECT sum(deadlocks) AS deadlocks FROM pg_stat_database WHERE datname = current_database();","refId":"F"}],"fieldConfig":{"defaults":{"unit":"short"}},"gridPos":{"h":2,"w":4,"x":4,"y":8}},{"type":"table","title":"Locks (Not Granted)","datasource":"Postgres","targets":[{"format":"table","rawSql":"SELECT pid, locktype, relation::regclass, mode, granted FROM pg_locks WHERE NOT granted;","refId":"G"}],"gridPos":{"h":4,"w":8,"x":8,"y":8}},{"type":"table","title":"Top Tables by Sequential Scans","datasource":"Postgres","targets":[{"format":"table","rawSql":"SELECT relname AS table, seq_scan FROM pg_stat_user_tables ORDER BY seq_scan DESC LIMIT 10;","refId":"H"}],"gridPos":{"h":4,"w":8,"x":0,"y":10}},{"type":"table","title":"Top Tables by Index Scans","datasource":"Postgres","targets":[{"format":"table","rawSql":"SELECT relname AS table, idx_scan FROM pg_stat_user_tables ORDER BY idx_scan DESC LIMIT 10;","refId":"I"}],"gridPos":{"h":4,"w":8,"x":8,"y":10}},{"type":"timeseries","title":"Queries per Minute","datasource":"Postgres","targets":[{"format":"time_series","rawSql":"SELECT date_trunc('minute', now()) as time, sum(xact_commit + xact_rollback) as queries FROM pg_stat_database WHERE datname = current_database() GROUP BY time ORDER BY time DESC LIMIT 60;","refId":"J"}],"fieldConfig":{"defaults":{"unit":"short"}},"gridPos":{"h":4,"w":8,"x":0,"y":14}},{"type":"table","title":"Table Bloat Estimate","datasource":"Postgres","targets":[{"format":"table","rawSql":"SELECT schemaname, relname, n_dead_tup FROM pg_stat_user_tables ORDER BY n_dead_tup DESC LIMIT 10;","refId":"M"}],"gridPos":{"h":4,"w":8,"x":8,"y":18}}]}
{{- end }}
